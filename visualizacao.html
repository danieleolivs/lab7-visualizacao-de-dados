<!DOCTYPE html>
<html lang="en" style="height: 100%">
<head>
  <meta charset="utf-8">
  <style>
    body {
      height: 100%;
      margin: 0;
      display: flex;
      flex-direction: column; 
    }
    #controls {
      position: absolute;
      top: 10px;
      right: 10px; 
      z-index: 10;
      background: white;
      padding: 5px 10px;
      border-radius: 5px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    #mapa {
      height: 60%; 
    }
    #container {
      height: 40%; 
    }
  </style>
</head>
<body>
  <div id="mapa"></div>
  <div id="container"></div>

  <div id="controls">

    <select id="selectData">
      <option value="EXP">Exportação</option>
      <option value="IMP">Importação</option>
      <option value="BAL">Balança Comercial (Exp - Imp)</option>
    </select>
  </div>

  <script src="https://fastly.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <script>
    const chartMapa = echarts.init(document.getElementById('mapa'));
    const myChart = echarts.init(document.getElementById('container'));

    let allData = null;

    fetch('BR-exportacoes_importacoes_2025.json')
    .then(res => res.json())
    .then(data => {
      allData = data;
      renderLinha(data);
      renderMapa('EXP');
    })
    .catch(console.error);

    function renderLinha(data) {
      const anos = Object.keys(data.BAL).sort(); 
      const exportacoes = anos.map(ano => data.EXP[ano].reduce((sum, item) => sum + item.us_value, 0));
      const importacoes = anos.map(ano => data.IMP[ano].reduce((sum, item) => sum + item.us_value, 0));
      const balancos = anos.map(ano => data.BAL[ano].reduce((sum, item) => sum + item.us_value, 0));

      const optionLinha = {
        grid: { left: '10%', right: '10%', bottom: '23%', containLabel: true },
        xAxis: {
          type: 'category',
          data: anos,
          name:'Série histórica',
          nameLocation: 'middle',
          nameGap: 30
        },
        yAxis: {
          type: 'value',
          name:'Bilhoes de US$',
          axisLabel: {
            formatter: function (value) {
              const num = Number(value) / 1e9;
              return num % 1 === 0 ? num.toString() : num.toFixed(2).replace(/\.?0+$/, '');
            }
          }
        },
        dataZoom: [
          { textStyle: { color: '#8392A5' },
            handleIcon:'path://M10.7,11.9v-1.3H9.3v1.3c-4.9,0.3-8.8,4.4-8.8,9.4c0,5,3.9,9.1,8.8,9.4v1.3h1.3v-1.3c4.9-0.3,8.8-4.4,8.8-9.4C19.5,16.3,15.6,12.2,10.7,11.9z M13.3,24.4H6.7V23h6.6V24.4z M13.3,19.6H6.7v-1.4h6.6V19.6z',
            dataBackground: { areaStyle: { color: '#8392A5' }, lineStyle: { opacity: 0.8, color: '#8392A5' } },
            brushSelect: true
          },
          { type: 'inside' }
        ],
        title: { text: 'Total por ano', left:115, textStyle: { fontSize: 12, fontWeight: 'bold', color: '#333' } },
        tooltip: { trigger: 'axis' },
        legend: { data: ['Exportação', 'Importação', 'Balança Comercial'] },
        series: [
          { name: 'Exportação', type: 'line', smooth: true, data: exportacoes, lineStyle:{ color:"#3b908c" }, itemStyle:{ color:"#3b908c" } },
          { name: 'Importação', type: 'line', smooth: true, data: importacoes, lineStyle:{ color:"#e06174" }, itemStyle:{ color:"#e06174" } },
          { name: 'Balança Comercial', type: 'line', smooth: true, data: balancos, lineStyle:{ type:'dashed', color:"#b1bdf5" }, itemStyle:{ color:"#b1bdf5" } }
        ]
      };

      myChart.setOption(optionLinha);
    }

    function renderMapa(tipo='EXP') {
      $.get('world.json', function(worldJson) {
        echarts.registerMap('world', worldJson);

        const anos = Object.keys(allData[tipo]).sort();
        const ultimoAno = anos[anos.length-1];

        const mapaData = allData[tipo][ultimoAno].map(item => ({
          name: item.name,
          value: item.us_value
        }));

        const optionMapa = {
            title: {
                text: 'Volume de ' + (tipo==='EXP'?'Exportação':tipo==='IMP'?'Importação':'Balança Comercial') + ' do Brasil',
                subtext: 'Dados do monitor do Comércio Exterior Brasileiro',
                left: 'center',
                top: 8,
                itemGap: 6
            },
            tooltip: { trigger: 'item', formatter: '{b}: US$ {c}' },
            visualMap: {
                min: Math.min(...mapaData.map(d=>d.value)),
                max: Math.max(...mapaData.map(d=>d.value)),
                text: ['Máximo','Mínimo'],
                orient:'vertical',
                right:20,
                top:'middle',
                textGap:10,
                itemHeight: 250,
                itemWidth:30,
                inRange: { color: ['#cae9db','#62868d'] },
                outOfRange: {              
                    color: ['#f0f0f0']     
                },
                formatter: (value) => {    
                    return value >= 1e9 ? (value/1e9).toFixed(1) + ' bi US$' : value;
                }
            },
            graphic: [{
                type: 'text',
                right: 10,  
                top: 'middle',
                rotation: -Math.PI / 2, 
                style: {
                    text: 'Total em US$',
                    fontSize: 14,
                    fontWeight: 'bold',
                    fill: '#333'
                }
            },
            {
                type: 'group',
                right: 10,  
                bottom: 20,  
                children: [
                {
                    type: 'rect',
                    shape: { width: 20, height: 20 },
                    style: { fill: '#f0f0f0', stroke: '#999' }
                },
                {
                    type: 'text',
                    left: 25,
                    top: 2,
                    style: {
                    text: 'Sem dados',
                    fontSize: 12,
                    fill: '#333'
                    }
                }
                ]
            }
            ],
            geo: {
                map: 'world',
                roam: true,
                top: 70,
                bottom: 10,
                itemStyle: {
                areaColor: '#e0f3ff',
                borderColor: '#999'
                },
                emphasis: {
                itemStyle: { areaColor: '#7f91b3' } 
                }
            },
            series: [{
                type: 'map',
                map: 'world',
                geoIndex: 0,  
                data: mapaData
            }]
            };


        chartMapa.setOption(optionMapa);
      });
    }

    document.getElementById('selectData').addEventListener('change', function() {
      const tipo = this.value;
      renderMapa(tipo);
    });

    window.addEventListener('resize', () => {
      chartMapa.resize();
      myChart.resize();
    });
  </script>
</body>
</html>
